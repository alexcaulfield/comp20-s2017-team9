
<!DOCTYPE html>

<!-- Client ID: 6cf2ef39b7f7482c8b1bf8e82aa50d43 -->
<!-- Client Secret: f034abd1393a4232b4fea34377a16943 -->


<html>
<head>
	<title>Game page</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<link rel ="stylesheet" href="bootstrap.css">
	<link rel="stylesheet" type="text/css" href="main.css">

<!--	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>-->

	<script type="text/javascript">
		$(document).ready(function(){
			$('navbar-collapse').dropdown()
		});
	</script>
</head>
<body onload="getPlaylist()" class="game_background">
    <nav class="navbar navbar-default" role="navigation">
	  <div class="container">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-brand-centered">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <div class="navbar-brand navbar-brand-centered"><a href="index.html">Pop Quiz</a></div>
	    </div>

	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="navbar-brand-centered">
	      <ul class="nav navbar-nav navbar-left">
	        <li><a href="howto.html">How to Play</a></li>
	        <li><a href="about.html">About</a></li>
	      </ul>
	      <ul class="nav navbar-nav navbar-right">
	        <li class="active"><a href="#">Game</a></li>
	        <li><a href="scoreboard.html">Scoreboard</a></li>		        
	      </ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>

	<button class="btn btn-default current-btn" type="button"><div id="currentSong">Current Song</div>
	<div id="song-preview0"></div></button><br><br><br>

<div style="width: 100%;">
<div style="float:left; width:50%">	
	<div class="song-btn"><button class="btn btn-default" type="button"><div id="songname1">Song 1</div>
	<div id="song-preview1"></div><button class="btn btn-default" id="picked1" onclick="update_prev(1)" type="button"> pick this one</button></button></div>

    <br><br>

	<div class="song-btn"><button class="btn btn-default" type="button"><div id="songname2">Song 2</div>
	<div id="song-preview2"></div><button class="btn btn-default" id="picked2" onclick="update_prev(2)" type="button"> pick this one</button></button></div><br><br><br>
</div>
<div style="float:right; width:50%">
	<div class="song-btn"><button class="btn btn-default" type="button"><div id="songname3">Song 3</div>
	<div id="song-preview3"></div><button class="btn btn-default" id="picked3" onclick="update_prev(3)" type="button"> pick this one</button></button></div>

    <br><br>

	<div class="song-btn"><button class="btn btn-default" type="button"><div id="songname4">Song 4</div>
	<div id="song-preview4"></div><button class="btn btn-default" id="picked4" onclick="update_prev(4)" type="button"> pick this one</button></button></div>
</div></div>
<div style="clear:both"></div>
	<script type="text/javascript">

	//this is test code to get the score db running. dont worry about it. im working on it -AH
/*	var mongoUri = process.env.MONGODB_URI || process.env.MONGOLAB_URI || process.env.MONGOHQ_URL || 'mongodb://ahanso01:Allball634@ds161190.mlab.com:61190/heroku_b3ks50c0';
	var MongoClient = require('mongodb').MongoClient, format = require('util').format;
	var db = MongoClient.connect(mongoUri, function(error, databaseConnection) {
		if(error){
			console.log("error"+ error)
		} else {
			console.log("successfully connected to db")
		}
		db = databaseConnection;
	});*/

    // how to make one audio file play at once html

	var previewUrl;
	var audioObject = null;
	//var meme_songs = ["6snnRz6kK978tSyUdejEyg", "4z6uwQKPhhIOOFCeiftv3J", "3xgK660fsZH7ZDcOMfIdfB", "0gfmYDvAZxOl6jXk1N9Fwy",   
//						 "4tCtwWceOPWzenK2HAIJSb", "0d5f6gzzW1Pgx9uJsLrSDP", "6umBH7xHLEU9RVhH4mpXQ3", "3cfOd4CMv2snFaKAnMdnvK", "3XWZ7PNB3ei50bTPzHhqA6", "5vIu19A3EEdHgFM4Cba6F4", "17tDv8WA8IhqE8qzuQn707", "4srpHYFHKjVGRDNHqRpWxi", "5Q0Nhxo0l2bP3pNjpGJwV1"];
                         // in order: hoohah, general patton, jungle, donald trump, work from home, bom bom (radio), bom bom (instrumental), all star, sandstorm, choices, my first kiss, TiK ToK, party in the USA

	var song1 = "";
    var song1_id = "";
	var song2 = "";
    var song2_id = "";
	var song3 = "";
    var song3_id = "";
	var song4 = "";
    var song4_id = "";
    var access_token = '';
    var prev_chosen_song_id = '';
    var newly_chosen_song_id = '';
    var score = 0;
    var song_features;
    var newly_chosen_song_features;
    var prev_chosen_song_features;
    var num_songs_on_playlist = 1;
    var EDMsongs = [];

    function getPlaylist() {
        // playlist URI: 3pK4cYF269adFRsBnEpkqy
        // user ID: cauf
        playlistUrl = 'https://api.spotify.com/v1/users/cauf/playlists/3pK4cYF269adFRsBnEpkqy' // EDM playlist
        $.get('https://pop-quiz-dj.herokuapp.com/auth', function(data){
            accessToken = data;

            $.ajax({
                url: playlistUrl,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                data: {
                    country: 'US',
                    fields: 'tracks.items(track(id))'
                },
                success: function (response) {
                    //console.log(response);
                    for (var i = 0; i < response.tracks.items.length; i++) {
                        EDMsongs[i] = response.tracks.items[i].track.id;
                    }
                    //console.log(EDMsongs);
                    getCurrentSong();
                },
                error: function (response) {
                    console.log(response);
                }
            });
        })    
    }

    function getCurrentSong() {
    	if (newly_chosen_song_id != '') {
            EDMsongs = EDMsongs.filter(function(el) {
                return el !== newly_chosen_song_id;  // removes songs from array when they are chosen
            });

            songUrl = "https://api.spotify.com/v1/tracks/";
            songUrl += newly_chosen_song_id;
            var trackPreview = document.getElementById('song-preview0');
            var songTitle = document.getElementById('currentSong');

            $.ajax({
                url: songUrl,
                data: {
                    country: 'US'
                },
            success: function (response) {
                audioObject = new Audio(); 
                trackPreview.innerHTML = '<audio class="song-audio" id="audio-player" style="width: 400px;" controls="controls" src="' +response.preview_url  + '" type="audio/mpeg">';
                songTitle.innerHTML = response.name;            
            },
            error: function (response) {
                alert("ERROR");
            }
            })
        } else {
            getSong(0);
        }
    }

    function update_prev(num){
        num_songs_on_playlist++;
        prev_chosen_song_id = newly_chosen_song_id;
        prev_chosen_song_features = newly_chosen_song_features;

        if (num == 1){ 
            newly_chosen_song_id = song1_id;
            requestToken(1);
        } else if (num ==2){
            newly_chosen_song_id = song2_id;
            requestToken(2);
        } else if (num == 3){
            newly_chosen_song_id = song3_id;
            requestToken(3);
        } else if (num == 4){
            newly_chosen_song_id = song4_id;
            requestToken(4);  
        }
    }

		function requestToken(num){
            console.log(EDMsongs);
            getCurrentSong(); // IS THIS THE RIGHT PLACE TO PUT THIS?
			$.get('https://pop-quiz-dj.herokuapp.com/auth', function(data){
                access_token = data;
                getSong(1, function(){
                    getSong(2, function(){
                        getSong(3, function(){
                            getSong(4, function(){
                                if (newly_chosen_song_id != ''){
                                    get_song_features(newly_chosen_song_id);
                                    //newly_chosen_song_features = song_features;
                                }
                            });
                        });
                    });
                });
			});
		}

        function get_score(num){
            //console.log("Got Score");
            //console.log(newly_chosen_song_features);

            var new_adj_bpm = (newly_chosen_song_features.tempo)/200;
            var prev_adj_bpm = (prev_chosen_song_features.tempo)/200;
            //console.log("new_adj_bpm: " + new_adj_bpm);
            //console.log("prev_adj_bpm: " + prev_adj_bpm);
            //console.log("bpm score: " + .25*(1 - (new_adj_bpm - prev_adj_bpm)));

            var new_energy = newly_chosen_song_features.energy;
            var prev_energy = prev_chosen_song_features.energy;
            //console.log("new_energy: " + new_energy);
            //console.log("prev_energy: " + prev_energy);
            //console.log("energy score: " + .25*(1 - (new_energy - prev_energy)));

            var new_dance = newly_chosen_song_features.danceability;
            var prev_dance = prev_chosen_song_features.danceability;
            //console.log("new_dance: " + new_dance);
            //console.log("prev_dance: " + prev_dance);
            //console.log("dance score: " + .25*(1 - (new_dance - prev_dance)));

            var new_val = newly_chosen_song_features.valence;
            var prev_val = prev_chosen_song_features.valence;
            //console.log("new_val: " + new_val);
            //console.log("prev_val: " + prev_val);
            //console.log("valence score: " + .25*(1 - (new_val - prev_val)));

            var similarity = .25*(1 - (new_adj_bpm - prev_adj_bpm)) + .25*(1 - (new_energy - prev_energy)) + .25*(1 - (new_dance - prev_dance)) + .25*(1 - (new_val - prev_val));

            //console.log("similarity: " + similarity);
            similarity *= 100;
            similarity = Math.round(similarity);
            score += similarity;
            console.log("score: " + score);

            if (num_songs_on_playlist == 5){
                window.alert("Your Score is: " + score);
                // add score into database
                window.location.replace("scoreboard.html");
            }
        }

        function get_song_features(song_id){
            var song_url = 'https://api.spotify.com/v1/audio-features/' + song_id;
            $.ajax({
                url: song_url,
                method: 'GET',
                headers: {
                	'Authorization': 'Bearer ' + access_token
                },
                data: {
                    country: 'US'
                },
                success: function(response){
                    newly_chosen_song_features = response;
                    console.log("new: " + newly_chosen_song_id);
                    //console.log(newly_chosen_song_features);
                    console.log("prev: " + prev_chosen_song_id);
                    //console.log(prev_chosen_song_features);
                    if (prev_chosen_song_id != ''){
                        get_score(0);
                    }
                },
                error: function(response){
                    get_song_features(song_id);
                   // console.log ("ERROR with url: " + song_url + " and access token " + access_token);
                }
            })
        };

		function getSong(num, callback) {
			var song_url = "https://api.spotify.com/v1/tracks/";
			while ((song_url == "https://api.spotify.com/v1/tracks/") || (song_url == song1) || (song_url == song2) || 
					(song_url == song3) || (song_url == song4)){
				song_url += EDMsongs[(Math.floor((Math.random() * 100) + 1))%(EDMsongs.length)];
			}

			var pre_track = 'song-preview';
				pre_track += num;

			var previewTrack = document.getElementById(pre_track);

		  $.ajax({
			url: song_url,
			data: {
			  country: 'US'
			},
			success: function (response) {
				previewUrl = response.preview_url;
				audioObject = new Audio(); 
				previewTrack.innerHTML = '<audio class="song-audio" id="audio-player" style="width: 400px;" controls="controls" src="' +response.preview_url  + '" type="audio/mpeg">';
                if (num == 0){
                    var songTitle = document.getElementById('currentSong');
                    songTitle.innerHTML = response.name;
                    EDMsongs = EDMsongs.filter(function(el) {
                        return el !== response.id;  // removes songs from array when they are chosen
                    });
                    newly_chosen_song_id = response.id;
                    requestToken(0);
                }
				if (num == 1){
					songname1.innerHTML = response.name;
					song1 = song_url;
                    // next line parses URL so that the var only holds song_id
                    song1_id = song1.replace("https://api.spotify.com/v1/tracks/","");
                    song1 = song_url;
				}
				else if (num == 2){
					songname2.innerHTML = response.name;
					song2 = song_url;
                    song2_id = song2.replace("https://api.spotify.com/v1/tracks/","");
                    song2 = song_url;
				}
				else if (num ==3){
					songname3.innerHTML = response.name;
					song3 = song_url;
                    song3_id = song3.replace("https://api.spotify.com/v1/tracks/","");
                    song3 = song_url;
				}
				else if (num ==4){
					songname4.innerHTML = response.name;
					song4 = song_url;
                    song4_id = song4.replace("https://api.spotify.com/v1/tracks/","");
                    song4 = song_url;
				}
                callback();
			},
			error: function (response) {
			   // console.log("ERROR: Track not found");
			   // console.log(song_url);

			   // do some sort of error handling - ming
			   // probably do some sort of catch like this? http://stackoverflow.com/questions/2833951/how-to-catch-ajax-query-post-error
			   //http://stackoverflow.com/questions/18864734/how-can-i-catch-jquery-ajax-errors
			   //http://stackoverflow.com/questions/4062317/jquery-get-error-response-function\
			   //function(XMLHttpRequest, textStatus, errorThrown) {
				   //  alert(errorThrown);
				 // }
                getSong(num);
                callback();
			}
		}).fail(function() {
        //console.log('fail', arguments);
        console.log("fail");
    });
		};

		function saveScore(username, score){
			db.scores.insert({"username":username, "score":score});
			console.log("Username: "+username+"inserted in db with score: "+score);
		}
	</script>

</body>
</html>			