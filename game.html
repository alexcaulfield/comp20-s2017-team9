<!DOCTYPE html>

<!-- Client ID: 6cf2ef39b7f7482c8b1bf8e82aa50d43 -->
<!-- Client Secret: f034abd1393a4232b4fea34377a16943 -->


<html>
<head>
	<title>Game page</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<link rel ="stylesheet" href="bootstrap.css">
	<link rel="stylesheet" type="text/css" href="main.css">

<!--	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>-->

	<script type="text/javascript">
		$(document).ready(function(){
			$('navbar-collapse').dropdown()
		});
	</script>
</head>
<body onload="requestToken(0)">
    <nav class="navbar navbar-default" role="navigation">
	  <div class="container">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-brand-centered">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <div class="navbar-brand navbar-brand-centered"><a href="index.html">Pop Quiz</a></div>
	    </div>

	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="navbar-brand-centered">
	      <ul class="nav navbar-nav navbar-left">
	        <li><a href="howto.html">How to Play</a></li>
	        <li><a href="about.html">About</a></li>
	      </ul>
	      <ul class="nav navbar-nav navbar-right">
	        <li class="active"><a href="#">Game</a></li>
	        <li><a href="scoreboard.html">Scoreboard</a></li>		        
	      </ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>
	
	<button class="btn btn-default" type="button"><div id="songname1">Song 1<button class="btn btn-default" id="picked1" onclick="update_prev(1)" type="button"> pick this one</button></div>
	<div id="song-preview1"></div></button><br><br><br>

	<button class="btn btn-default" type="button"><div id="songname2">Song 2<button class="btn btn-default" id="picked2" onclick="update_prev(2)" type="button"> pick this one</button></div>
	<div id="song-preview2"></div></button><br><br><br>

	<button class="btn btn-default" type="button"><div id="songname3">Song 3<button class="btn btn-default" id="picked3" onclick="update_prev(3)" type="button"> pick this one</button></div>
	<div id="song-preview3"></div></button><br><br><br>

	<button class="btn btn-default" type="button"><div id="songname4">Song 4<button class="btn btn-default" id="picked4" onclick="update_prev(4)" type="button"> pick this one</button></div>
	<div id="song-preview4"></div></button>

	<script type="text/javascript">

	var previewUrl;
	var audioObject = null;
	var meme_songs = ["6snnRz6kK978tSyUdejEyg", "4z6uwQKPhhIOOFCeiftv3J", "3xgK660fsZH7ZDcOMfIdfB", "0gfmYDvAZxOl6jXk1N9Fwy",   
						 "4tCtwWceOPWzenK2HAIJSb", "0d5f6gzzW1Pgx9uJsLrSDP", "6umBH7xHLEU9RVhH4mpXQ3", "3cfOd4CMv2snFaKAnMdnvK"];
                         // in order: hoohah, general patton, jungle, donald trump, work from home, bom bom (radio), bom bom (instrumental), all star

	var song1 = "";
    var song1_id = "";
	var song2 = "";
    var song2_id = "";
	var song3 = "";
    var song3_id = "";
	var song4 = "";
    var song4_id = "";
    var access_token = '';
    var prev_song_id = '';
    var score = 0;
    var song_features;

    function update_prev(num){
        if (num == 1){
            prev_song_id = song1_id;
            requestToken(1);
        }else if (num ==2){
            prev_song_id = song2_id;
            requestToken(2);
        }else if (num == 3){
            prev_song_id = song3_id;
            requestToken(3);
        }else if (num == 4){
            prev_song_id = song4_id;
            requestToken(4);
        }

      //  console.log(prev_song_id);
    }

		function requestToken(num){
			$.get('https://pop-quiz-dj.herokuapp.com/auth', function(data){
                access_token = data;
                getSong(1, function(){
                    getSong(2, function(){
                        getSong(3, function(){
                            getSong(4, function(){
                                if (prev_song_id != ''){
                                    get_score(num);
                                }
                            });
                        });
                    });
                });
			});
		}

        function get_score(num){
            var new_song_id = '';

            if (num == 1){
                new_song_id = song1_id;
            }else if (num == 2){
                new_song_id = song2_id; //sets the new_song_id to the correct id value
            }else if (num == 3){
                new_song_id = song3_id;
            }else if (num == 4){
                new_song_id = song4_id;
            }

            console.log(prev_song_id);
            console.log(new_song_id);

            get_song_features(new_song_id);
            var new_song_features = song_features; 
            get_song_features(prev_song_id);            // doesn't work because fuck asynchronous javascript
            var prev_song_features = song_features;

            console.log(new_song_features);
            console.log(prev_song_features);

        }

        function get_song_features(song_id){
            var song_url = 'https://api.spotify.com/v1/audio-features/' + song_id;
            $.ajax({
                url: song_url,
                method: 'GET',
                headers: {
                	'Authorization': 'Bearer ' + access_token
                },
                data: {
                    country: 'US'
                },
                success: function(response){
                    //console.log(response);
                    song_features = response;
                },
                error: function(response){
                   // console.log ("ERROR with url: " + song_url + " and access token " + access_token);
                }
            })
        };

		function getSong(num, callback) {

			var song_url = "https://api.spotify.com/v1/tracks/";
			while ((song_url == "https://api.spotify.com/v1/tracks/") || (song_url == song1) || (song_url == song2) || 
					(song_url == song3) || (song_url == song4)){
				song_url += meme_songs[(Math.floor((Math.random() * 100) + 1))%(meme_songs.length)];
			}

			var pre_track = 'song-preview';
				pre_track += num;

			var previewTrack = document.getElementById(pre_track);

		  $.ajax({
			url: song_url,
			data: {
			  country: 'US'
			},
			success: function (response) {
				previewUrl = response.preview_url;
				audioObject = new Audio(); 
				previewTrack.innerHTML = '<audio id="audio-player" controls="controls" src="' +response.preview_url  + '" type="audio/mpeg">';
				if (num == 1){
					songname1.innerHTML = response.name;
					song1 = song_url;
                    song1_id = song1.replace("https://api.spotify.com/v1/tracks/","");
                    song1 = song_url;
                    get_song_features(song1_id);
				}
				else if (num == 2){
					songname2.innerHTML = response.name;
					song2 = song_url;
                    song2_id = song2.replace("https://api.spotify.com/v1/tracks/","");
                    song2 = song_url;
                    get_song_features(song2_id);
				}
				else if (num ==3){
					songname3.innerHTML = response.name;
					song3 = song_url;
                    song3_id = song3.replace("https://api.spotify.com/v1/tracks/","");
                    song3 = song_url;
                    get_song_features(song3_id);
				}
				else if (num ==4){
					songname4.innerHTML = response.name;
					song4 = song_url;
                    song4_id = song4.replace("https://api.spotify.com/v1/tracks/","");
                    song4 = song_url;
                    get_song_features(song4_id);
				}
                callback();
			},
			error: function (response) {
			   // console.log("ERROR: Track not found");
			   // console.log(song_url);
                getSong(num);
                callback();
			}
		})
		};
	</script>

</body>
</html>			